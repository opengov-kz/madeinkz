import csv
import psycopg2
import os
from datetime import datetime

def convert_date(value):
    """Конвертирует дату в формат YYYY-MM-DD, если она не пустая."""
    if value in ["", "-"]:
        return None
    try:
        return datetime.strptime(value, "%d.%m.%y").strftime("%Y-%m-%d") 
    except ValueError:
        try:
            return datetime.strptime(value, "%Y.%m.%d").strftime("%Y-%m-%d") 
        except ValueError:
            print(f"Ошибка конвертации даты: {value}")
            return None

def transfer_multiple_csv_to_postgres(db_params, transfer_configs):
    conn = None
    try:
        # Подключение к PostgreSQL
        conn = psycopg2.connect(**db_params)
        
        for config in transfer_configs:
            csv_file_path = config['csv_file_path']
            table_mappings = config['table_mappings']
            
            print(f"\nОбработка файла: {csv_file_path}")
            
            if not os.path.exists(csv_file_path):
                print(f"Ошибка: Файл {csv_file_path} не найден.")
                continue
            
            try:
                with open(csv_file_path, 'r', encoding='utf-8') as csv_file:
                    csv_reader = csv.DictReader(csv_file)
                    csv_columns = csv_reader.fieldnames
                    
                    all_csv_columns = set()
                    for mapping in table_mappings:
                        all_csv_columns.update(mapping['column_mapping'].keys())
                    
                    missing_columns = [col for col in all_csv_columns if col not in csv_columns]
                    if missing_columns:
                        print(f"Ошибка: В файле {csv_file_path} отсутствуют следующие колонки: {missing_columns}")
                        print(f"Доступные колонки: {csv_columns}")
                        continue
                    
                    csv_data = list(csv_reader)
                    
                    for mapping in table_mappings:
                        table_name = mapping['table_name']
                        column_mapping = mapping['column_mapping']
                        
                        print(f"Загрузка данных в таблицу: {table_name}")
                        
                        db_columns = list(column_mapping.values())
                        placeholders = ", ".join(["%s"] * len(db_columns))
                        columns_str = ", ".join(db_columns)
                        
                        if table_name in ["Получатели", "Производители"]:
                            insert_query = f"""
                                INSERT INTO {table_name} ({columns_str}) 
                                VALUES ({placeholders}) 
                                ON CONFLICT (ИИН_БИН) DO NOTHING
                            """
                        else:
                            insert_query = f"INSERT INTO {table_name} ({columns_str}) VALUES ({placeholders})"
                        
                        cursor = conn.cursor()
                        inserted_rows = 0
                        
                        for row in csv_data:
                            values = [convert_date(row.get(csv_col, '').strip()) if 'дата' in csv_col.lower() else 
                                      (None if row.get(csv_col, '').strip() in ["-", ""] else row.get(csv_col, '').strip())
                                      for csv_col in column_mapping.keys()]
                            
                            try:
                                cursor.execute(insert_query, values)
                                inserted_rows += 1
                            except Exception as e:
                                print(f"Ошибка при вставке строки в таблицу {table_name}: {e}")
                                conn.rollback()
                                continue
                        
                        conn.commit()
                        print(f"Успешно загружено {inserted_rows} строк в таблицу {table_name}")
                        cursor.close()
            
            except Exception as e:
                print(f"Ошибка при чтении файла {csv_file_path}: {e}")
                continue
        
        print("\nПроцесс загрузки данных завершен.")
    
    except Exception as e:
        print(f"Общая ошибка: {e}")
    finally:
        if conn:
            conn.close()

if __name__ == "__main__":
    db_params = {
        "host": "localhost",
        "database": "sertifikaty",
        "user": "postgres",
        "password": "1234",
        "port": "5432"
    }
    transfer_configs = [
        {
            'csv_file_path': 'project/results/stkz_certificates_2_1.csv',
            'table_mappings': [
                {
                    'table_name': 'Сертификаты',
                    'column_mapping': {
                        'Код РПП': 'Код_РПП',
                        'Наименование РПП': 'Наименование_РПП',
                        'Номер сертификата происхождения': 'Номер_сертификата',
                        'Номер бланка': 'Номер_бланка',
                        'Год выдачи': 'Год_выдачи',
                        'Цель получения сертификата': 'Цель_получения_сертификата',
                        'Категория': 'Категория',
                        'ИИН/ БИН производителя': 'ИИН_БИН_производителя',
                        'ИИН/БИН получателя': 'ИИН_БИН_получателя',
                        'Дата окончания действия сертификата': 'Дата_окончания_действия',
                        'Статус сертификата': 'Статус_сертификата',
                        'Дата выдачи': 'Дата_выдачи'
                    }
                },
                {
                    'table_name': 'Получатели',
                    'column_mapping': {
                        'ИИН/БИН получателя': 'ИИН_БИН',
                        'Наименование получателя': 'Наименование_получателя',
                        'Адрес получателя': 'Адрес_получателя'
                    }
                },
                {
                    'table_name': 'Производители',
                    'column_mapping': {
                        'ИИН/ БИН производителя': 'ИИН_БИН',
                        'Наименование производителя': ' Наименование_производителя',
                        'Адрес производителя': 'Адрес_производителя'
                    }
                },
            ]
        },
                {
            'csv_file_path': 'project/results/stkz_certificates_3_1.csv',
            'table_mappings': [
                {
                    'table_name': 'Сертификаты',
                    'column_mapping': {
                        'Номер сертификата происхождения': 'Номер_сертификата',
                        'Наименование РПП': 'Наименование_РПП',
                        'Номер бланка': 'Номер_бланка',
                        'Статус сертификата': 'Статус_сертификата',
                        'Дата выдачи': 'Дата_выдачи'
                    }
                },
                {
                    'table_name': 'Сертификаты_на_продукцию',
                    'column_mapping': {
                        'Номер сертификата происхождения': 'Номер_сертификата',
                        'Наименование РПП': 'Наименование_РПП',
                        'Форма сертификата': 'Форма_сертификата',
                        'Номер бланка': 'Номер_бланка',
                        'ИИН/БИН отправителя/экспортера': 'ИИН_БИН_отправителя',
                        'Наименование отправителя/экспортера': 'Наименование_отправителя',
                        'Адрес отправителя/экспортера': 'Адрес_отправителя',
                        'Код ТН ВЭД': 'Код_ТН_ВЭД',
                        'Критерий происхождения': 'Критерий_происхождения',
                        'Страна происхождения товара': 'Страна_происхождения',
                        'Страна получателя/импортера': 'Страна_получателя',
                        'Статус сертификата': 'Статус_сертификата',
                        'Дата выдачи':  'Дата_выдачи'
                    }
                },
            ]
        },
                {
            'csv_file_path': 'project/results/stkz_certificates_3_1.csv',
            'table_mappings': [
                {
                    'table_name': 'Сертификаты',
                    'column_mapping': {
                        'Номер сертификата происхождения': 'Номер_сертификата',
                        'Наименование РПП': 'Наименование_РПП',
                        'Номер бланка': 'Номер_бланка',
                        'Статус сертификата': 'Статус_сертификата',
                        'Дата выдачи': 'Дата_выдачи'
                    }
                },
                {
                    'table_name': 'Сертификаты_на_продукцию',
                    'column_mapping': {
                        'Номер сертификата происхождения': 'Номер_сертификата',
                        'Наименование РПП': 'Наименование_РПП',
                        'Форма сертификата': 'Форма_сертификата',
                        'Номер бланка': 'Номер_бланка',
                        'ИИН/БИН отправителя/ экспортера': 'ИИН_БИН_отправителя',
                        'Наименование отправителя/ экспортера': 'Наименование_отправителя',
                        'Адрес отправителя/ экспортера': 'Адрес_отправителя',
                        'Код ТН ВЭД': 'Код_ТН_ВЭД',
                        'Критерий происхождения': 'Критерий_происхождения',
                        'Страна происхождения товара': 'Страна_происхождения',
                        'Страна получателя/ импортера': 'Страна_получателя',
                        'Статус сертификата': 'Статус_сертификата',
                        'Дата выдачи':  'Дата_выдачи'
                    }
                },
            ]
        },
                {
            'csv_file_path': 'project/results/stkz_certificates_4_1.csv',
            'table_mappings': [
                {
                    'table_name': 'Сертификаты',
                    'column_mapping': {
                        'Номер сертификата происхождения': 'Номер_сертификата',
                        'Наименование РПП': 'Наименование_РПП',
                        'Номер бланка': 'Номер_бланка',
                        'Статус сертификата': 'Статус_сертификата',
                        'Дата выдачи': 'Дата_выдачи'
                    }
                },
                {
                    'table_name': 'Сертификаты_на_продукцию',
                    'column_mapping': {
                        'Номер сертификата происхождения': 'Номер_сертификата',
                        'Наименование РПП': 'Наименование_РПП',
                        'Форма сертификата': 'Форма_сертификата',
                        'Номер бланка': 'Номер_бланка',
                        'ИИН/БИН отправителя/экспортера': 'ИИН_БИН_отправителя',
                        'Наименование отправителя/экспортера': 'Наименование_отправителя',
                        'Адрес отправителя/экспортера': 'Адрес_отправителя',
                        'Код ТН ВЭД': 'Код_ТН_ВЭД',
                        'Критерий происхождения': 'Критерий_происхождения',
                        'Страна происхождения товара': 'Страна_происхождения',
                        'Страна получателя/импортера': 'Страна_получателя',
                        'Статус сертификата': 'Статус_сертификата',
                        'Дата выдачи':  'Дата_выдачи'
                    }
                },
            ]
        },
                {
            'csv_file_path': 'project/results/stkz_certificates_5_1.csv',
            'table_mappings': [
                {
                    'table_name': 'Сертификаты',
                    'column_mapping': {
                        'Номер сертификата происхождения': 'Номер_сертификата',
                        'Наименование РПП': 'Наименование_РПП',
                        'Номер бланка': 'Номер_бланка',
                        'Статус сертификата': 'Статус_сертификата',
                        'Дата выдачи': 'Дата_выдачи'
                    }
                },
                {
                    'table_name': 'Сертификаты_на_продукцию',
                    'column_mapping': {
                        'Номер сертификата происхождения': 'Номер_сертификата',
                        'Наименование РПП': 'Наименование_РПП',
                        'Форма сертификата': 'Форма_сертификата',
                        'Номер бланка': 'Номер_бланка',
                        'ИИН/БИН отправителя/ экспортера': 'ИИН_БИН_отправителя',
                        'Наименование отправителя/ экспортера': 'Наименование_отправителя',
                        'Адрес отправителя/ экспортера': 'Адрес_отправителя',
                        'Код ТН ВЭД': 'Код_ТН_ВЭД',
                        'Критерий происхождения': 'Критерий_происхождения',
                        'Страна происхождения товара': 'Страна_происхождения',
                        'Страна получателя/ импортера': 'Страна_получателя',
                        'Статус сертификата': 'Статус_сертификата',
                        'Дата выдачи':  'Дата_выдачи'
                    }
                },
            ]
        },
                {
            'csv_file_path': 'project/results/stkz_certificates_6_1.csv',
            'table_mappings': [
                {
                    'table_name': 'Сертификаты',
                    'column_mapping': {
                        'Номер сертификата происхождения': 'Номер_сертификата',
                        'Наименование РПП': 'Наименование_РПП',
                        'Номер бланка': 'Номер_бланка',
                        'Статус сертификата': 'Статус_сертификата',
                        'Дата выдачи': 'Дата_выдачи'
                    }
                },
                {
                    'table_name': 'Сертификаты_на_продукцию',
                    'column_mapping': {
                        'Номер сертификата происхождения': 'Номер_сертификата',
                        'Наименование РПП': 'Наименование_РПП',
                        'Форма сертификата': 'Форма_сертификата',
                        'Номер бланка': 'Номер_бланка',
                        'ИИН/БИН отправителя/ экспортера': 'ИИН_БИН_отправителя',
                        'Наименование отправителя/ экспортера': 'Наименование_отправителя',
                        'Адрес отправителя/ экспортера': 'Адрес_отправителя',
                        'Код ТН ВЭД': 'Код_ТН_ВЭД',
                        'Критерий происхождения': 'Критерий_происхождения',
                        'Страна происхождения товара': 'Страна_происхождения',
                        'Страна получателя/ импортера': 'Страна_получателя',
                        'Статус сертификата': 'Статус_сертификата',
                        'Дата выдачи':  'Дата_выдачи'
                    }
                },
            ]
               },
                {
            'csv_file_path': 'project/results/stkz_certificates_7_1.csv',
            'table_mappings': [
                {
                    'table_name': 'Сертификаты',
                    'column_mapping': {
                        'Номер сертификата происхождения': 'Номер_сертификата',
                        'Наименование РПП': 'Наименование_РПП',
                        'Номер бланка': 'Номер_бланка',
                        'Статус сертификата': 'Статус_сертификата',
                        'Дата выдачи': 'Дата_выдачи'
                    }
                },
                {
                    'table_name': 'Сертификаты_на_продукцию',
                    'column_mapping': {
                        'Номер сертификата происхождения': 'Номер_сертификата',
                        'Наименование РПП': 'Наименование_РПП',
                        'Форма сертификата': 'Форма_сертификата',
                        'Номер бланка': 'Номер_бланка',
                        'ИИН/БИН отправителя/экспортера': 'ИИН_БИН_отправителя',
                        'Наименование отправителя/экспортера': 'Наименование_отправителя',
                        'Адрес отправителя/экспортера': 'Адрес_отправителя',
                        'Код ТН ВЭД': 'Код_ТН_ВЭД',
                        'Критерий происхождения': 'Критерий_происхождения',
                        'Страна происхождения товара': 'Страна_происхождения',
                        'Страна получателя/импортера': 'Страна_получателя',
                        'Статус сертификата': 'Статус_сертификата',
                        'Дата выдачи':  'Дата_выдачи'
                    }
                },
            ]
        },
        {
            'csv_file_path': 'project/results/goods_certificates_1_1.csv',
            'table_mappings': [
                {
                    'table_name': 'Индустриальные_сертификаты',
                    'column_mapping': {
                        'Регистрационный номер индустриального сертификата': 'Регистрационный_номер_индустриал',
                        'БИН/ИИН': 'БИН_ИИН',
                        'Наименование производителей товаров, работ, услуг': 'Наименование_производителей',
                        'Вид деятельности согласно ОКЭД (перв, вторич.)': 'Вид_деятельности_ОКЭД',
                        'Регион согласно КАТО': 'Регион_КАТО',
                        'Юридический адрес': 'Юридический_адрес',
                        'Почтовый (фактический) адрес': 'Почтовый_адрес',
                        'Телефон': 'Телефон',
                        'Электронный адрес': 'Электронный_адрес',
                        'Web - сайт': 'Web_сайт',
                        'ТН ВЭД ЕАЭС': 'ТН_ВЭД_ЕАЭС',
                        'КП ВЭД': 'КП_ВЭД',
                        'Номер документа об оценке соотвествия': 'Номер_документа_о_оценке_соответс',
                        'Дата выдачи документа об оценке соотвествия': 'Дата_выдачи_документа',
                        'Номер и дата лицензии или разрешения': 'Номер_и_дата_лицензии',
                        'Количество сотрудников': 'Количество_сотрудников',
                        'Дата включения в Реестр': 'Дата_включения_в_реестр',
                        'Дата внесения изменений и/или дополнений': 'Дата_внесения_изменений',
                        'Дата проведения актуализации сведений, указанных в Реестре': 'Дата_актуализации'
                    }
                },
            ]
        }
        
    ]
    
    transfer_multiple_csv_to_postgres(db_params, transfer_configs)
